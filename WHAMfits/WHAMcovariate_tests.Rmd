---
title: "Attempt recruitment covariates in herring WHAM model"
author: "Sarah Gaichas"
date: "`r Sys.Date()`"
output:
  html_document:
    code_fold: hide
link-citations: yes
csl: "canadian-journal-of-fisheries-and-aquatic-sciences.csl"
bibliography: zoopindex.bib
urlcolor: blue
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      message = FALSE,
                      warning = FALSE)

library(tidyverse)
library(here)
library(DT)
library(patchwork)
library(wham)

```

# Introduction

Now that we have way too many copeopod time series, lets see if any of them are useful covariates in the Atlantic herring assessment model.

The primary target is a covariate on Atlamntic herring recruitment. 

Adelle's boosted regression tree model shows both spring large copepods and fall small copepods as important factors explaining recruitment patterns estimated by the WHAM model.

We have also developed a herring-larvae specific small copepod index within the area with more than the 70th percentile of cumulative 1982-2022 herring larvae density.  

So we can try at least three flavors of copepod index as a model covariate.

# Methods

Installed multiWHAM from the `devel` branch: https://github.com/timjmiller/wham/tree/devel

`devtools::install_github("timjmiller/wham", dependencies=TRUE, ref="devel")`

Installation worked on the outdated mac os... so far. 

Lets test the installation by seeing if I can get the same outputs as Jon did by running the model without any additions.

Modify Jon's code from the Atlantic Herring RTWG google drive and now in this directory, `Example WHAM code to share.R` which sources his `WHAMfxns.R` and `hindcast.R` also now in this directory.

First run the base model and compare with the stored to ensure my installation is ok:

```{r, eval=FALSE}
#source some functions
source(here::here("WHAMfits/WHAMfxns.R"))
#source the hindcast function for MASE etc.
source(here::here("WHAMfits/hindcast.R"))

# starting with mm192, add suffix for different attempts
# test with no change

config <- "nochange"

# name the model directory
name <- paste0("mm192_", config)

write.dir <- here::here(sprintf("WHAMfits/%s/", name))

if(!dir.exists(write.dir)) {
  dir.create(write.dir)
}

# copy the input dat file to model directory
asapRun2_87 <- here::here("WHAMfits/mm192/Run2_87.DAT")
file.copy(from=file.path(asapRun2_87), to=write.dir, overwrite=FALSE)

asapRun2dat<- read_asap3_dat(here::here(write.dir, "Run2_87.DAT"))

# need data files read in to run these--but don't, 
# the full data object is already available in the mm192 rds file
#asapRun2dat=CVfxn(asapRun9dat) #empirical CVs
#asapRun2dat=ESSfxn(asapRun9dat,addnumcatch=150,addnumsurv=150)

mm192mod <- readRDS(here::here("WHAMfits/mm192/mm192_meanrecpar.rds"))

input <- mm192mod$input

m1 <- fit_wham(input, do.osa = F)

saveRDS(m1, file.path(write.dir, "mm192nochange.rds"))

check_convergence(m1)

# these should be identical; they are
test <- compare_wham_models(mods = list("orig" = mm192mod, "nochange" = m1), fdir = write.dir)

saveRDS(test, file.path(write.dir, "compare.rds"))

```

The original model and my rerun using the same inputs (nochange) directly overlap:

```{r}
knitr::include_graphics(here::here("WHAMfits/mm192_nochange/compare_png/compare_SSB_F_R.png"))
```

New explore environmental covariate (ecov) options. What format does the input need?

Following https://timjmiller.github.io/wham/articles/ex2_CPI_recruitment.html columns Year, Index, Index_sigma

We are testing indices of bottom-up recruitment impacts--food for larvae, postlarvae, and juveniles

Format ecov indices; we'll try at least 3 variants:

*  Spring large copepods (food for postlarvae and juveniles, series tested in boosted regression tree)
*  Fall small copepods (food for larvae, series tested in boosted regression tree)
*  Sep-Feb small copepods in herring larval area (food for larvae, new series not tested in boosted regression tree but developed to better match timing and area of herring larvae)

The code in [WHAMinputs.R](https://github.com/NOAA-EDAB/zooplanktonindex/blob/main/WHAMinputs.R) was used to create csv files of the VAST derives zooplankton indices. Files are saved in the [WHAMfits](https://github.com/NOAA-EDAB/zooplanktonindex/tree/main/WHAMfits) folder.

Start with spring large copepods. Following the suggestions in [WHAM vignette 2](https://timjmiller.github.io/wham/articles/ex2_CPI_recruitment.html):

OK thats outmoded. Can just add an ecov object to existing input using `set_ecov`:

```{r, eval=FALSE}

config <- "largecope"

# name the model directory
name <- paste0("mm192_", config)

write.dir <- here::here(sprintf("WHAMfits/%s/", name))

if(!dir.exists(write.dir)) {
  dir.create(write.dir)
}

mm192mod <- readRDS(here::here("WHAMfits/mm192/mm192_meanrecpar.rds"))

input <- mm192mod$input

# asapdat<- read_asap3_dat(here::here("WHAMfits/mm192/Run2_87.DAT"))
# 
# asap3 <- input$asap3

env.dat <- read.csv(here::here("WHAMfits/springlargecopeindex.csv"), header=T)

# make it the same length as model ?
#env.dat <- env.dat[env.dat$Time > 1986,]

# test a single ecov setup with no effect first
ecov_on <- list(
    label = "lgCopeSpr",
    mean = as.matrix(env.dat$her_sp_Estimate),
    logsigma = "est_1", #as.matrix(log(env.dat$her_sp_SE)),
    year = env.dat$Time,
    use_obs = matrix(1, ncol=1, nrow=dim(env.dat)[1]), # use all obs (all = 1)
    lag = 0, # postlarval and juvenile food in year t affects recruitment in year t
    process_model = 'rw', # "rw" or "ar1"
    #where = "recruit",
    recruitment_how = as.matrix("controlling-lag-0-linear")) # 0 = no effect, 1 = controlling, 2 = limiting

# modify current model input call adding ecov list
#input$call

ecovinput <- set_ecov(input, ecov=ecov_on)

# ecovinput <- prepare_wham_input(asap3 = asapdat, # correct structurr, asap3 is wrong structure
#                                 model_name = "test", #df.mods[m, "Model"],
#                                 ecov = ecov,
#                                 recruit_model = 2, 
#                                 selectivity = list(fix_pars = list(7:8, 
#                                                                    2, 
#                                                                    c(1:2, 4:8), 
#                                                                    1:8, 
#                                                                    c(1, 3:8), 
#                                                                    NULL, 
#                                                                    c(1, 4:8), 
#                                                                    NULL)), 
#                                 M = list(re_model = as.matrix("none")), #as.matrix(df.mods[m, "M_re"])), 
#                                 NAA_re = list(sigma = "rec+1", 
#                                               cor = "ar1_a", #df.mods[m, "naa_cor"], 
#                                               N1_model = "age-specific-fe", #init_Nnum[m], 
#                                               decouple_recruitment = TRUE), 
#                                 age_comp = "logistic-normal-ar1-miss0", 
#                                 basic_info = list(bias_correct_process = FALSE, 
#                                                   bias_correct_BRPs = FALSE, 
#                                                   percentSPR = 40, 
#                                                   percentFXSPR = 100, 
#                                                   XSPR_R_avg_yrs = 6:35, 
#                                                   XSPR_R_opt = 5))

ecovon_mod <- fit_wham(ecovinput, do.osa = F)

saveRDS(ecovon_mod, file.path(write.dir, "testecovon.rds"))

plot_wham_output(mod = ecovon_mod, dir.main = file.path(write.dir))

# test a single ecov setup with no effect first
ecov_off <- list(
    label = "lgCopeSpr",
    mean = as.matrix(env.dat$her_sp_Estimate),
    logsigma = as.matrix(log(env.dat$her_sp_SE)),
    year = env.dat$Time,
    use_obs = matrix(1, ncol=1, nrow=dim(env.dat)[1]), # use all obs (all = 1)
    lag = 0, # postlarval and juvenile food in year t affects recruitment in year t
    process_model = 'rw', # "rw" or "ar1"
    #where = "recruit",
    recruitment_how = as.matrix("none")) # 0 = no effect, 1 = controlling, 2 = limiting

# modify current model input call adding ecov list
#input$call

ecovinput <- set_ecov(input, ecov=ecov_off)

mod <- fit_wham(ecovinput, do.osa = F)

saveRDS(mod, file.path(write.dir, "testecovoff.rds"))


#compare to original, not the same data
test <- compare_wham_models(mods = list("testcovoff" = mod, "testecovon" = readRDS(file.path(write.dir, "testecovon.rds"))), fdir = write.dir)

```

The model runs with ecov in but not turned on. Results looks similar to the base model, but can't be directly compared because different datasets.

Lets try a suite of models with the same recruitment process but different ways the large copepod series relates to it.

We'll always use recruitment process 2, random about mean, because that is in mm192.

We'll look at both random walk "rw" and AR1 "ar1" processes for the environmental covariate. 

Environmental covariates will link to recruitment not at all (0), as a controlling process (1), as a limiting process (2), or as a masking process (4). The other two possible processes, lethal (3) and directive/behavioral (5) make less sense to me for a food covariate on recruitment but I could be convinced to try them next. 

```{r, eval=FALSE}

# larger set of ecov setups to compare
df.mods <- data.frame(Recruitment = c(rep(2, 8)),
                      ecov_process = c(rep("rw",4),rep("ar1",4)),
                      ecov_how = c(0,1,2,4,0,1,2,4), stringsAsFactors=FALSE)
n.mods <- dim(df.mods)[1]
df.mods$Model <- paste0("m",1:n.mods)
df.mods <- dplyr::select(df.mods, Model, tidyselect::everything()) # moves Model to first col

for(m in 1:n.mods){
  ecov <- list(
    label = "lgCopeSpr",
    mean = as.matrix(env.dat$her_sp_Estimate),
    logsigma = as.matrix(log(env.dat$her_sp_SE)),
    year = env.dat$Time,
    use_obs = matrix(1, ncol=1, nrow=dim(env.dat)[1]), # use all obs (all = 1)
    lag = 0, # postlarval and juvenile food in year t affects recruitment in year t
    process_model = df.mods$ecov_process[m],  # "rw" or "ar1"
    where = c("recruit")[as.logical(df.mods$ecov_how[m])+1],
    how = df.mods$ecov_how[m]) # 0 = no effect, 1 = controlling, 2 = limiting
  
  # modify current model input call adding ecov list
  #input$call
  
  ecovinput <- prepare_wham_input(asap3 = asapdat, # correct structurr, asap3 is wrong structure
                                  model_name = "test", #df.mods[m, "Model"],
                                  ecov = ecov,
                                  recruit_model = df.mods$Recruitment[m], 
                                  selectivity = list(fix_pars = list(7:8, 
                                                                     2, 
                                                                     c(1:2, 4:8), 
                                                                     1:8, 
                                                                     c(1, 3:8), 
                                                                     NULL, 
                                                                     c(1, 4:8), 
                                                                     NULL)), 
                                  M = list(re_model = as.matrix("none")), #as.matrix(df.mods[m, "M_re"])), 
                                  NAA_re = list(sigma = "rec+1", 
                                                cor = "ar1_a", #df.mods[m, "naa_cor"], 
                                                N1_model = "age-specific-fe", #init_Nnum[m], 
                                                decouple_recruitment = TRUE), 
                                  age_comp = "logistic-normal-ar1-miss0", 
                                  basic_info = list(bias_correct_process = FALSE, 
                                                    bias_correct_BRPs = FALSE, 
                                                    percentSPR = 40, 
                                                    percentFXSPR = 100, 
                                                    XSPR_R_avg_yrs = 6:35, 
                                                    XSPR_R_opt = 5))
  
  mod <- fit_wham(ecovinput, do.osa = T)
  
  # Save model
  saveRDS(mod, file=paste0(df.mods$Model[m],".rds"))
  
  # Plot output in new subfolder
  plot_wham_output(mod=mod, dir.main=file.path(write.dir,df.mods$Model[m]), out.type='html')
  
}

```




