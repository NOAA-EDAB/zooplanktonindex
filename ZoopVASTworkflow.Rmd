---
title: "Zooplankton VAST index standardization"
author: "Sarah Gaichas"
date: "`r Sys.Date()`"
output:
  html_document:
    code_fold: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      message = FALSE,
                      warning = FALSE)

library(tidyverse)
library(here)
library(DT)
library(ggiraph)
```

# Introduction

The Atlantic herring research track working group is interested in exploring zooplankton indices within the assessment.

These indices could potentially explain:
1.  herring growth/condition
1.  herring recruitment
1.  patterns in herring "survival" random effects

We have zooplankton indices already in `ecodata` at the EPU scale. These were reviewed with the working group in March 2024 (see [here](https://noaa-edab.github.io/forageindex/ZooplanktonOverview.html)). 

However, we want to examine the scale of herring assessment and different combinations of zooplankton species than currently exist in `ecodata`.

We'll try VAST models for index standardization using the ECOMON data as an input.

Set of decisions:

1.  zooplankton species
2.  which zooplankton metric (area or volume)
3.  spatial footprint
4.  temporal scale (seasonal? annual?)
5.  potential covariates

# Explore data

## Zooplankton data

Read in file obtained from Scott Large, source of his zooplankton models:

```{r}
ecomonall <- read_csv("data/EcoMon_Plankton_Data_v3_8.csv")

names(ecomonall)
```

A lookup of these column headings is here: https://www.fisheries.noaa.gov/inport/item/35054

## Herring diets

What herring eat from our food habits data is summarized here:  https://fwdp.shinyapps.io/tm2020/

Copepods are highest diet proportion, followed by well digested prey (AR), and euphausiids. These are aggregate categories so I should look at the breakdown to species.

```{r}
# run the diet script that we used for bluefish? gives diet by season and year
# Load NEFSC stomach data received from Brian Smith


# put the get_diet function on this repo in R folder
source(here::here("R/get_diet.R"))

# what is the code
ecodata::species_groupings |> dplyr::filter(RPATH == "AtlHerring")

# get diet takes SVSPP as argument
herringdiet <- get_diet(32) 

p1 <-   ggplot(herringdiet, aes(year, relmsw, fill=prey)) +
   geom_bar(stat = "identity") + #
   ylab("Percent in Diet") +
   xlab("Year") +
   facet_wrap("season", nrow=4) +
   theme_bw() +
   viridis::scale_fill_viridis(discrete = TRUE) +
   theme(legend.position = "none"
         #legend.position="bottom",
         #legend.text=element_text(size=5)
         ) +
    geom_bar_interactive(stat = "identity", aes(tooltip = prey, data_id = prey))

ggiraph(code = print(p1), height=14)  

```

# Initial decisions

## 1. Zooplankton species: VAST Categories

Maybe start with total zooplankton volume, Copepoda, Euphausiids, and *Calanus finmarchicus*? And keep both spatial units. These would be separate univariate models, though we could try a multivariate model with all too.

It appears that Copepoda in the ecomon dataset is not all copepods together, as I hoped, but is unid copepods. Very few are in the data.

So I will sum everything that Harvey classified as a copeopod in [this spreadsheet that he shared with Scott](https://github.com/NOAA-EDAB/zooplanktonindex/blob/main/data/ForageTaxaUse_August2022.xlsx). 

```{r}
herringfood <- ecomonall |>
  dplyr::mutate(allcopepods_10m2 = sum(ctyp_10m2,
                                       calfin_10m2,
                                       pseudo_10m2,
                                       tlong_10m2,
                                       cham_10m2,
                                       para_10m2,
                                       acarspp_10m2,
                                       mlucens_10m2,
                                       calminor_10m2,
                                       clauso_10m2,
                                       acarlong_10m2,
                                       euc_10m2,
                                       fur_10m2,
                                       calspp_10m2,
                                       ost_10m2,
                                       temspp_10m2,
                                       tort_10m2,
                                       paraspp_10m2,
                                       na.rm = TRUE
                                       ),
                allcopepods_100m3 = sum(ctyp_100m3,
                                       calfin_100m3,
                                       pseudo_100m3,
                                       tlong_100m3,
                                       cham_100m3,
                                       para_100m3,
                                       acarspp_100m3,
                                       mlucens_100m3,
                                       calminor_100m3,
                                       clauso,
                                       acarlong_100m3,
                                       euc_100m3,
                                       fur_100m3,
                                       calspp_100m3,
                                       ost_100m3,
                                       temspp_100m3,
                                       tort_100m3,
                                       paraspp_100m3,
                                       na.rm = TRUE
                                       )
                ) |>
  dplyr::select(cruise_name, station, zoo_gear, ich_gear, lat, lon, date, time, depth, 
                sfc_temp, sfc_salt, btm_temp, btm_salt, volume_1m2, volume_100m3,
                allcopepods_10m2, allcopepods_100m3, euph_10m2, euph_100m3,
                hyper_10m2, hyper_100m3, calfin_10m2, calfin_100m3) |>
  dplyr::mutate(date = lubridate::dmy(date),
                year = lubridate::year(date),
                month = lubridate::month(date),
                day = lubridate::day(date))

nonzeroobs <- herringfood |>
  dplyr::group_by(year, month) |>
  dplyr::summarise(cope =  sum(allcopepods_100m3 != 0, na.rm = TRUE),
                   euph = sum(euph_100m3 != 0, na.rm = TRUE), 
                   hyp = sum(hyper_100m3 != 0, na.rm = TRUE),
                   calfin = sum(calfin_100m3 != 0, na.rm = TRUE))
```

So we will look at total zooplankton displacement volume: `volume_1m2, volume_100m3`

Total euphausiids:  `euph_10m2, euph_100m3`

Total hyperiids: `hyper_10m2, hyper_100m3`

*Calanus finmarchicus*: `calfin_10m2, calfin_100m3`

Total copeopds: summing over the following names for each of the area or volume metrics, only area shown here

`ctyp_10m2, calfin_10m2, pseudo_10m2, tlong_10m2, cham_10m2,  para_10m2,  acarspp_10m2,  mlucens_10m2, calminor_10m2, clauso_10m2, acarlong_10m2, euc_10m2, fur_10m2, calspp_10m2, ost_10m2, temspp_10m2, tort_10m2, paraspp_10m2`

These are the corresponding species names, with Large copepods denoted by * 

Centropages typicus, Calanus finmarchicus\*, Pseudocalanus spp., Temora longicornis, Centropages hamatus, Paracalanus parvus, Acartia spp., Metridia lucens\*, Calanus minor\*, Clausocalanus arcuicornis, Acartia longiremis, Eucalanus spp.\*, Clausocalanus furcatus,  Calanus spp.\*, Temora stylifera, Temora spp., Tortanus discaudatus, Paracalanus spp.


Dataset years extend from `r sort(unique(herringfood$year))[1]` to `r sort(unique(herringfood$year))[length(unique(herringfood$year))]`

This is a list of stations with nonzero samples by year and month to better understand seasonal coverage. 

```{r}
DT::datatable(nonzeroobs)
```

## 2. Which metric? 

Ryan recommends the numbers per 100 cubic meters of filtered water volume `_100m3` data, which should match what is used in the SOE indices. However, he thinks that anomalies calculated from the area `_10m2` data should be the same as those calculated from the volume based numbers. This makes sense to me.

Let's start with the `_100m3` numbers for each category. We can try one with the other metric and see if it does make a difference as well.


## 3. Spatial scale options:

1.  Herring survey strata (differ by spring and fall)
2.  EPUs for comparison with SOE datasets
3.  Full shelf/AllEPU 


## 4. Temporal scale options: 

I need to decide how to break up the data temporally, thinking by season associated with herring population processes. So there could be a winter index, a spring index, a summer index, and a fall index. What months?

Mark W's herring spawn timing info could be useful here. Do they feed while spawning?

Alternatively, at least two seasons should match the bottom trawl survey timing if we want to use these indices as covariates for availability/catchability. 

Mark W's info also looked at changes in survey timing.

1.  4 models, 2 matching survey seasons (spring/fall) and try two for winter and summer to cover other portions of herring life history. 
1.  Alternatively, roll winter into spring and summer into fall as done for bluefish.
1.  Not sure an annual model makes sense for zooplankton but we could try it, may compare with SOE indices?

## 5. Covariates

Probably at a minimum temperature should be explored. Catchability or habitat? Its both

Day of year or day of season? potential catchability covariate for this high turnover group

A frontal index might be useful? As a habitat covaraite?

### Temperature

We will need to merge in alternative temperature to use all the data since some are NAs. 

We have `r dim(herringfood)[1]` rows (stations) total, `r `dim(herringfood |> dplyr::filter(!is.na(sfc_temp)))[1]` that have surface temperature, and `r `dim(herringfood |> dplyr::filter(!is.na(btm_temp)))[1]` that have bottom temperature.

This can be done with the OISST data as was done for the forage index, or the bottom temperature data as was done for the benthos index.

Likely surface temperature is more relevant for zooplankton?

### Day of year

We can derive from date field in dataset, convert to season for seasonal models
