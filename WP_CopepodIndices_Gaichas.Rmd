---
title: 'Working Paper: Developing zooplankton indices in VAST'
author: "Sarah Gaichas"
date: "`r Sys.Date()`"
output:
  html_document:
    code_fold: hide
link-citations: yes
csl: "canadian-journal-of-fisheries-and-aquatic-sciences.csl"
bibliography: zoopindex.bib
urlcolor: blue
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      warning = FALSE,
                      message = FALSE)

library(tidyverse)
library(FishStatsUtils)
```

# Introduction

The Atlantic herring research track working group (WG) is interested in exploring impacts of food availability on herring stock dynamics. Indices of zooplankton abundance were proposed for exploration. 

These indices could potentially explain:

1.  herring recruitment 
1.  herring growth/condition 
1.  patterns in herring "survival" random effects  

The WG decided to focus on patterns in recruitment, as low recruitment in recent years is an important issue for the stock and for fishery management.

The WG used a boosted regression tree analysis (Molina 2024) to identify zooplankton indices that best explained patterns in herring recruitment.  These indices included large copepods in spring (influencing growth of herring postlarvae and juveniles), and small copeopods in fall (influencing survival of herring larvae over the winter).

In this working paper, we develop indices of large copepods in spring and small copepods in fall using zooplankton survey data (citation) from 1982-2022. We tailor the indices to the spatial footprint of the Atlantic herring stock assessment, and further use information on the changing spatial distribution of herring larvae over time from the same dataset to evaluate potential changes in availability of small copepods to herring larvae. 


# Methods

We used spatio-temporal modeling to develop zooplankton indices using the ECOMON data as an input.  

Decisions:

1.  zooplankton species
2.  which zooplankton metric (area or volume)
3.  spatial footprint
4.  temporal scale (seasonal? annual?)
5.  potential covariates

## Zooplankton species

We use herring diet information to determine which zooplankton species to include. This information is from both literature and food habits data. 

"The herring is a plankton feeder.... Examination of 1,500 stomachs showed that adult herring near Eastport were living solely on copepods and on pelagic euphausiid shrimps (*Meganyctiphanes norwegica*), fish less than 4 inches long depending on the former alone, while the larger herring were eating both. When first hatched, and before the disappearance of the yolk sac, the larvae (European) feed on larval snails and crustaceans, on diatoms, and on peridinians, but they soon begin taking copepods, and depend exclusively on these for a time after they get to be 12 mm. long, especially on the little Pseudocalanus elongatus. As they grow older they feed more and more on the larger copepods and amphipods, pelagic shrimps, and decapod crustacean larvae [@collette_bigelow_2002]."

What herring eat from NEFSC food habits data is summarized here:  https://fwdp.shinyapps.io/tm2020/
Copepods are highest diet proportion, followed by well digested prey (AR), and euphausiids. Broken down by decade and season, it is clear that copeopods dominate adult diets in winter and spring, and more so recently. 

Maybe copeopods are bad for hering??

```{r herrdietdecade, fig.width = 10.5, fig.asp=.8}
# Use Brian's new Rmd to get herring diet by decade and season or season and region

herringdiet <- readRDS(here::here("data/herringdiet.rds"))

herringdecseastot <- herringdiet %>%
  # make decade column
  # make 2 seasons winter--> spring and summer--> fall
  dplyr::mutate(decade = floor(year/10)*10) |>
                #season2 = case_when(season %in% c("WINTER", "SPRING") ~ "SPRING",
                #                    season %in% c("SUMMER", "FALL") ~ "FALL")) %>%
                #season2 = case_when(season %in% c( "SPRING") ~ "SPRING",
                #                    season %in% c( "FALL") ~ "FALL")) %>%
  dplyr::select(decade, season, totwt) %>%
  dplyr::distinct() %>%
  dplyr::group_by(decade, season) %>%
  dplyr::mutate(totwt2 = sum(totwt, na.rm = TRUE),
                nyrs = n_distinct(year)) %>%
  dplyr::select(decade, season, totwt2, nyrs) %>%
  dplyr::distinct()

diet <- read.csv(here::here("data/allwtp2024-09-28.csv"))

preylook <- read.csv(here::here("data/SASPREY24.csv"))

preylook <- dplyr::select(preylook, c(Pynam, pycomnam, COLLCAT))

# add blueprey list
decadeseason <- diet %>%
  dplyr::mutate(copeprey = ifelse(prey %in% c("COPEPO"), TRUE, FALSE),
                plotcol = ifelse(copeprey, "blue", "lightgrey"),
                decade = as.integer(gsub("s","",decade))) %>%
  dplyr::left_join(herringdecseastot, by=c("season" = "season", 
                                            "decade" = "decade")) %>%

  dplyr::group_by(decade, season) %>%
  dplyr::filter(meansw>0) %>%
  dplyr::arrange(desc(copeprey), .by_group = TRUE)


bars <- map(unique(decadeseason$decade)
            , ~geom_bar(aes(width=nyrs), stat = "identity", colour = "white"#, position = "stack", 
                       , data = decadeseason %>% filter(decade == .x)))


p2 <-   ggplot(decadeseason, aes(decade, relmsw, fill=copeprey)) +
                                    #fill=factor(prey, 
                                    #            levels = c(as.factor(names(preycolaggsel)),
                                    #                       setdiff(prey, preycolaggsel)),
                                    #           ordered = TRUE
                                    #           ))) +
   #geom_bar(aes(width=nyrs), stat = "identity") + #
   bars +
   ylab("Percent in Diet") +
   xlab("Decade") +
   geom_text(aes(y=relmsw, 
             label = ifelse(relmsw > 3, prey, "")),
             position = position_stack(vjust = 0.5),
             size=2.5)+
   facet_wrap(~fct_relevel(season,"WINTER", "SPRING","SUMMER", "FALL")) +
   theme_bw() +
   #viridis::scale_fill_viridis(discrete = TRUE) +
   scale_fill_manual(values=c( "grey90", "lightblue")) + 
   theme(legend.position = "none"
         #legend.position="bottom",
         #legend.text=element_text(size=5)
         ) #+
    #geom_bar_interactive(stat = "identity", aes(tooltip = prey, data_id = prey))

#ggiraph(code = print(p1)) 
#p1

p2


```

Focus is on recruitment, food for larvae through juveniles.

Models developed for the Herring RT are for the following copepod categories:

*   Large copepods ALL:  *Calanus finmarchicus*,  *Metridia lucens*, *Calanus minor*,  *Eucalanus* spp.,  *Calanus* spp.

*   Small copepods ALL:  *Centropages typicus*, *Pseudocalanus* spp., *Temora longicornis*, *Centropages hamatus*, *Paracalanus parvus*, *Acartia* spp., *Clausocalanus arcuicornis*, *Acartia longiremis*, *Clausocalanus furcatus*,  *Temora stylifera*, *Temora* spp., *Tortanus discaudatus*, *Paracalanus* spp.

These categories included all life stages of each copepod species.

(Models were also developed for *Calanus finmarchicus* alone, total zooplankton volume, and Euphausiids, but are not presented here.)

An additional model was developed for Atlantic herring larvae using the same dataset in order to characterize the spatial extent of herring larvae compared with their zooplankton prey. This model was not used as an index due to missing data during several years of the time series.

## Zooplankton metric

Previous zooplankton indices use the numbers per 100 cubic meters of filtered water volume `_100m3` data [@kane_zooplankton_2007 ; @morse_distinct_2017]. Other current analyses use the numbers per 100 cubic meters as well. 

## Spatial scale

NEFSC survey strata definitions are built into the VAST `northwest-atlantic` extrapolation grid already. Therefore, fall and spring survey strata sets used in the Atlantic herring assessment were also applied to the zooplankton indices. Indices were also calculated in Ecological Production Units (EPUs) used in regional ecosystem reporting (Fig. \ref{fig:maps}). 

```{r}

herring_spring <- c(01010, 01020, 01030, 01040, 01050, 01060, 01070, 01080, 01090, 
                    01100, 01110, 01120, 01130, 01140, 01150, 01160, 01170, 01180, 
                    01190, 01200, 01210, 01220, 01230, 01240, 01250, 01260, 01270, 
                    01280, 01290, 01300, 01360, 01370, 01380, 01390, 01400, 01610, 
                    01620, 01630, 01640, 01650, 01660, 01670, 01680, 01690, 01700, 
                    01710, 01720, 01730, 01740, 01750, 01760)
herring_fall <- c(01050, 01060, 01070, 01080, 01090, 01100, 01110, 01120, 01130, 
                  01140, 01150, 01160, 01170, 01180, 01190, 01200, 01210, 01220, 
                  01230, 01240, 01250, 01260, 01270, 01280, 01290, 01300, 01360, 
                  01370, 01380, 01390, 01400)

MAB <- c(1010:1080, 1100:1120, 1600:1750, 3010:3450, 3470, 3500, 3510)
GB  <- c(1090, 1130:1210, 1230, 1250, 3460, 3480, 3490, 3520:3550)
GOM <- c(1220, 1240, 1260:1290, 1360:1400, 3560:3830)
SS  <- c(1300:1352, 3840:3990)

D70pct_nwast <- readRDS(url("https://github.com/NOAA-EDAB/zooplanktonindex/raw/main/spatialdat/D70pct_nwa_strat2.rds"))

# MAB EPU
MAB2 <- D70pct_nwast %>% 
  dplyr::filter(stratum_number %in% MAB) 

# MAB herring larvae area
MAB2herr <- MAB2 %>%
  dplyr::filter(stratum_number2 %% 10 == 1) 

# MAB outside larval area
MAB2out <- MAB2 %>%
  dplyr::filter(stratum_number2 %% 10 == 2) 

# Georges Bank EPU
GB2 <- D70pct_nwast %>% 
  dplyr::filter(stratum_number %in% GB) 

# GB herring larvae
GB2herr <- GB2 %>%
  dplyr::filter(stratum_number2 %% 10 == 1) 

#GB outside larval area
GB2out <- GB2 %>%
  dplyr::filter(stratum_number2 %% 10 == 2)

# gulf of maine EPU 
GOM2 <- D70pct_nwast %>%
  dplyr::filter(stratum_number %in% GOM)

# GOM herring larvae
GOM2herr <- GOM2 %>%
  dplyr::filter(stratum_number2 %% 10 == 1) 

#GOM outside larval area
GOM2out <- GOM2 %>%
  dplyr::filter(stratum_number2 %% 10 == 2)

# scotian shelf EPU 
SS2 <- D70pct_nwast %>%
  dplyr::filter(stratum_number %in% SS) 

# SS herring larvae
SS2herr <- SS2 %>%
  dplyr::filter(stratum_number2 %% 10 == 1) 

#SS outside larval area
SS2out <- SS2 %>%
  dplyr::filter(stratum_number2 %% 10 == 2)

# whole herring larval area
herrlarv <- dplyr::bind_rows(MAB2herr, GB2herr, GOM2herr, SS2herr)

# outside herring larval area
nolarv <- dplyr::bind_rows(MAB2out, GB2out, GOM2out, SS2out)

# spring herring NEFSC BTS
her_spr2 <- D70pct_nwast %>%
  dplyr::filter(stratum_number %in% herring_spring) 

# fall herring NEFSC BTS
her_fall2 <- D70pct_nwast %>%
  dplyr::filter(stratum_number %in% herring_fall) 

# all epus
allEPU2 <- D70pct_nwast %>%
  dplyr::filter(stratum_number %in% c(MAB, GB, GOM, SS)) 


```

```{r maps, crop=TRUE, fig.cap="Maps of key areas for Herring assessment indices. The full VAST model grid is shown in brown.", fig.show='hold', out.width="33%"}

theme_set(theme_bw())

ggplot(data = ecodata::coast) +
  geom_sf() + 
  geom_point(data = FishStatsUtils::northwest_atlantic_grid, aes(x = Lon, y = Lat),  colour = "coral4", size=0.05, alpha=0.1) +
  geom_point(data = MAB2, aes(x = Lon, y = Lat), colour = "green3", size=0.05, alpha=0.5) +
  geom_point(data = GB2, aes(x = Lon, y = Lat), colour = "orange", size=0.05, alpha=0.5) +
  geom_point(data = GOM2, aes(x = Lon, y = Lat), colour = "red", size=0.05, alpha=0.5) +
  geom_point(data = SS2, aes(x = Lon, y = Lat), colour = "purple", size=0.05, alpha=0.1) +
  #coord_sf(xlim = c(-79, -65.5), ylim = c(33, 45)) + #full extent of VAST model
  coord_sf(xlim =c(-78, -65.5), ylim = c(35, 45)) + #zoomed to Hatteras and N
  ggtitle("MAB (green), GB (orange), GOM (red), SS(purple)")


ggplot(data = ecodata::coast) +
  geom_sf() + 
  geom_point(data = FishStatsUtils::northwest_atlantic_grid, aes(x = Lon, y = Lat),  colour = "coral4", size=0.05, alpha=0.1) +
  geom_point(data = her_spr2, aes(x = Lon, y = Lat), size=0.05, colour = "yellow",  alpha=0.7) +
  #geom_point(data = her_fall2, aes(x = Lon, y = Lat), size=0.03, colour = "lightblue",  alpha=0.3) +
  #coord_sf(xlim = c(-79, -65.5), ylim = c(33, 45)) +
  coord_sf(xlim =c(-78, -65.5), ylim = c(35, 45)) +
  ggtitle("Herring spring (yellow) survey strata")

ggplot(data = ecodata::coast) +
  geom_sf() + 
  geom_point(data = FishStatsUtils::northwest_atlantic_grid, aes(x = Lon, y = Lat),  colour = "coral4", size=0.05, alpha=0.1) +
  #geom_point(data = her_spr2, aes(x = Lon, y = Lat), size=0.05, colour = "yellow",  alpha=0.1) +
  geom_point(data = her_fall2, aes(x = Lon, y = Lat), size=0.03, colour = "lightblue",  alpha=0.7) +
  #coord_sf(xlim = c(-79, -65.5), ylim = c(33, 45)) +
  coord_sf(xlim =c(-78, -65.5), ylim = c(35, 45)) +
  ggtitle("Herring fall (light blue) survey strata")


# ggplot(data = ecodata::coast) +
#   geom_sf() + 
#   geom_point(data = FishStatsUtils::northwest_atlantic_grid, aes(x = Lon, y = Lat),  colour = "coral4", size=0.05, alpha=0.1) +
#   geom_point(data = her_spr2, aes(x = Lon, y = Lat), size=0.05, colour = "yellow",  alpha=0.1) +
#   geom_point(data = herrlarv, aes(x = Lon, y = Lat), size=0.03, colour = "blue",  alpha=0.5) +
#   #coord_sf(xlim = c(-79, -65.5), ylim = c(33, 45)) +
#   coord_sf(xlim =c(-78, -65.5), ylim = c(35, 45)) +
#   ggtitle("Herring larval area Sept-Feb (blue), over spring survey strata (yellow")

```


## Temporal scale

Options explored for temporal scale included:

1.  An annual model mixes many generations of zooplankton; "all" is months 1-12
1.  Splitting the year into two seasons, rolling winter into spring and summer into fall is done for multiple fish species
    *  "SPRING" months 1-6
    *  "FALL" months 7-12
1.  Splitting the year into 4 seasons, 2 matching survey seasons (spring/fall) and try two for winter and summer to cover other portions of herring life history. Current designations are
    *  "winter" months 12, 1, 2
    *  "spring" months 3, 4, 5
    *  "summer" months 6, 7, 8
    *  "fall" months 9, 10, 11
1.  Finally, timing of herring larvae in the system was derived from the herring larvae data
    *  "sepfeb" months 9-12 and 1-2 of the following year
    *  "nolarv" months 3-8

Sample sizes in each of these temporal categories are reported below.

```{r}

herringfood_stn <- readRDS(here::here("data/herringfood_stn_all_OISST.rds"))

# make SST column that uses surftemp unless missing or 0

herringfood_stn <- herringfood_stn |>
  dplyr::mutate(sstfill = ifelse((is.na(sfc_temp)|sfc_temp==0), oisst, sfc_temp),
                season_larv = month %in% c(1:2, 9:12)) |>
  dplyr::filter(year>1981)

alltot <- herringfood_stn |> 
  dplyr::summarise(totstn = n(),
                   across(c(calfin_100m3,
                            lgcopeALL_100m3,
                            smallcopeALL_100m3,
                            cluhar_100m3,
                            euph_100m3,
                            volume_100m3
                            ), ~ sum(.x != 0, na.rm = TRUE))) |>
  dplyr::mutate(season = "all")


seasontot <- herringfood_stn |> 
  dplyr::group_by(season = season_ng) |>
  dplyr::summarise(totstn = n(),
                   across(c(calfin_100m3,
                            lgcopeALL_100m3,
                            smallcopeALL_100m3,
                            cluhar_100m3,
                            euph_100m3,
                            volume_100m3
                            ), ~ sum(.x != 0, na.rm = TRUE)))

season4tot <- herringfood_stn |> 
  dplyr::group_by(season = season_4) |>
  dplyr::summarise(totstn = n(),
                   across(c(calfin_100m3,
                            lgcopeALL_100m3,
                            smallcopeALL_100m3,
                            cluhar_100m3,
                            euph_100m3,
                            volume_100m3
                            ), ~ sum(.x != 0, na.rm = TRUE)))

larvtot <- herringfood_stn |> 
  dplyr::mutate(season = dplyr::if_else(season_larv, "sepfeb", "nolarv")) |>
  dplyr::group_by(season) |>
  dplyr::summarise(totstn = n(),
                   across(c(calfin_100m3,
                            lgcopeALL_100m3,
                            smallcopeALL_100m3,
                            cluhar_100m3,
                            euph_100m3,
                            volume_100m3
                            ), ~ sum(.x != 0, na.rm = TRUE)))

samptab <- dplyr::bind_rows(alltot, seasontot, season4tot, larvtot) |>
  dplyr::select(season, 
                stations = totstn,
                zoopvol = volume_100m3,
                largecope = lgcopeALL_100m3,
                smallcope = smallcopeALL_100m3,
                herringlarv = cluhar_100m3,
                calanusfin = calfin_100m3,
                euphausid = euph_100m3)
  
flextable::flextable(samptab) |>
  flextable::set_caption("Number of survey stations 1982-2022 by season with number of postive samples by zooplankton species group.") |>
  flextable::colformat_double(big.mark = "", digits = 0) |>
  #flextable::autofit()
  flextable::width(width = 1)

```

Testing models with data split over 4 seasons for 1982-2022 resulted in poor model performance, inability to estimate parameters, and lack of convergence for cases where parameters could be estimated. Therefore, we used the SPRING = January-June and FALL = July-December temporal scale as a starting point. 

## Spatio-temporal modeling

We applied the Vector Autoregressive Spatio-Temporal (VAST) model [@thorson_comparing_2017; @thorson_guidance_2019] to estimate zooplankton indices from zooplankton survey data. 

VAST is a Geostatistical generalized linear mixed effects model (GLMM) that models two linear predictors for an index: 1. encounter rate,  and 2. positive catch (amount in stomach)

A full model for the first linear predictor $\rho_1$ for each observation $i$ can include:
*  fixed intercepts $\beta_1$ for each category $c$ and time $t$, 
*  spatial random effects $\omega_1$ for each location $s$ and category, 
*  spatio-temporal random effects $\varepsilon_1$ for each location, category, and time, 
*  fixed vessel effects $\eta_1$ by vessel $v$ and category, and 
*  fixed catchability impacts $\lambda_1$ of covariates $Q$ for each observation and variable $k$: 

$$\rho_1(i) = \beta_1(c_i, t_i) + \omega_1^*(s_i, c_i) + \varepsilon_1^*(s_i, c_i, t_i) + \eta_1(v_i, c_i) + \sum_{k=1}^{n_k} \lambda_1(k) Q(i,k)$$ 

The full model for the second linear predictor $\rho_2$ has the same structure, estimating $\beta_2$, $\omega_2$, $\varepsilon_2$, $\eta_2$, and $\lambda_2$ using the observations, categories, locations, times, and covariates. 

VAST model code and documentation is available here: https://github.com/James-Thorson-NOAA/VAST 

Spatial and spatio-temporal correlation decay with increasing distance estimated as $\kappa$ in a Matern function with fixed smoothness and geometric anisotropy (directional correlation, optionally estimated by the model). 

Initial model selection consistently supported the inclusion of spatial and spatio-temporal random effects and anisotropy across all datasets: fall, spring, and annual. 

Observations in space are used to define fixed locations ("knots") covering the full extent of the model. We assume constant variation within a timestep at a knot. 

Modelers specify the number of knots to group observation locations, to balance computation time and resolution. We used 500 knots (Fig. \ref{fig:knots}).

```{r knots}
knitr::include_graphics(here::here("pyindex/lgcopeALL_spring_500_biascorrect_doy/Data_and_knots.png"))
```

Observations correlated in space and in space over time due to unmeasured processes are modeled as multivariate normal Gaussian Random Fields (GRF):

$\omega_1$ ~ MVN(0, $\mathbf R_1$); $\omega_2$ ~ MVN(0, $\mathbf R_2$)   
$\varepsilon_1$(,t) ~ MVN(0, $\mathbf R_1$); $\varepsilon_2$(,t) ~ MVN(0, $\mathbf R_2$) 

Spatial and spatio-temporal correlation decay with increasing distance $\mathbf d$ estimated as $\kappa$ in a Mat&eacute;rn function with fixed smoothness $\nu$ and geometric anisotropy $H$ (directional correlation). 
  
Correlation function between locations $s$ and $s'$:

$$\mathbf R_1(s, s') = \frac{1}{2^{\nu-1}\Gamma(\nu)} \times (\kappa_1 \lvert \mathbf d(s,s') \mathbf H  \rvert)^\nu \times K_\nu (\kappa_1 \lvert \mathbf d(s,s') \mathbf H  \rvert)$$

Estimation uses stochastic partial differential equation (SPDE) approximation.

Observation model "Index2", Gamma distribution for positive catches and Alternative "Poisson-link delta-model" using log-link for numbers-density and log-link for biomass per number. It is intended for continuous data, which includes biomass data and “numbers standardized to a fixed area.”

Probability of encounter Poisson: $p(i) = 1 - exp[-n(i)]$ *set to 1 for groups found at all stations, e.g. small copepods or zooplankton volume*

Number of zooplankton cells per volume given encounter: $r(i) = \frac{n(i)}{p(i)}w(i)$

Probability for numbers per volume $B$ where $g$ is a Gamma function.  :

$$ Pr[b(i) = B] =  \begin{cases} 1-p(i), B = 0\\\\p(i) \times g[B|r(i), \sigma_b^2], B > 0 \end{cases},$$  

We are interpreting zooplankton abundance per 100 cubic meters as numbers standardized to a fixed area (volume) in applying the Gamma observation model.

Density $b$ at a location (knot) $s$ for year $t$ is then the predicted number of cells per volume (linear predictor for encounter * linear predictor for cells/vol given encounter):

$$\hat{b}_{s,t} = \hat{n}_{s,t}\hat{w}_{s,t}$$

Index based on area $a$ weighting for each of 500 knots (or subsets): 

$$I_t = \sum_{s=1}^{500} a_s\hat{b}_{s,t}$$

Bias correction as in @thorson_implementing_2016.


# Results

# Discussion

# References

